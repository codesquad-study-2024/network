### story4. 서버에서 연결을 끊어 소켓을 말소한다

> 송/수신 단계 이후, 서버와 클라이언트의 소켓이 끊어지는 과정을 학습

#### 데이터 보내기를 완료했을 때 연결을 끊는다
1. HTTP 1.0 웹 통신의 경우, 서버에서 먼저 연결을 끊는다는 신호를 보내게 된다. 
2. 서버측 어플리케이션이 `close`를 호출하여 과정이 시작되고, 컨트롤 비트의 FIN 비트를 1로 설정하여 연결 끊기 정보가 담긴 패킷을 전송한다.
3. 해당 패킷을 받은 클라이언트의 프로토콜 스택은 끝내기 작업에 들어가야 한다는 것을 인식하고, 어플리케이션에게 이를 통지한다.
4. 어플리케이션은 마찬가지로 `close`를 호출하여 연결을 끊는 패킷을 다시 서버측에 반송한다.
5. 서버에서 수신을 완료하여 ACK 번호가 돌아오면 연결 끊기가 완료된다.

#### 소켓을 말소한다
연결이 종료되어도 바로 소켓을 말소하지 않고 혹시 모를 오동작을 막기 위해 잠시 대기한 후 소켓을 말소한다.

### story5. IP와 이더넷의 패킷 송 수신 동작

> 패킷을 운반하는 역할을 담당하는 IP가 어떻게 패킷을 상대방에게 보내는가?

#### 패킷의 기본
패킷은 **헤더**와 **데이터**의 두 부분으로 구성된다. 헤더에는 택배의 전표와 같은 제어 정보가 들어 있고, 데이터에는 전송해야 할 데이터가 들어 있다.

송신처에서 수신처에 도착하기까지 라우터와 허브라는 중계 장치들을 거쳐서 패킷이 이동하게 된다.

허브는 이더넷의 규칙에 따라, 라우터는 IP의 규칙에 따라 패킷을 운반하는데 이는 각각 MAC 헤더와 IP 헤더의 제어 정보에 따른다.

<img width="961" alt="스크린샷 2024-07-31 오후 5 05 05" src="https://github.com/user-attachments/assets/92bfab35-47c2-464a-9a67-c2e929908810">

#### 패킷 송수신 동작의 개요
TCP에서 TCP 헤더 + 데이터 조각 상태의 패킷을 IP에게 넘겨주면, IP는 이 패킷 앞에 다시 IP 헤더와 MAC 헤더를 추가한다.

IP 헤더에는 IP 주소로 표시된 목적지까지 패킷을 전달할 때 사용하는 제어 정보가 들어 있다.  
MAC 헤더에는 이더넷과 같은 LAN을 사용하여 올바른 위치로 가는 가장 가까운 라우터까지 패킷을 전달할 때 사용하는 제어 정보가 들어 있다.

그러면 이 패킷을 다시 네트워크 하드웨어에게 넘기고, 여기에서 1과 0의 패킷의 내용들이 빛과 전기신호로 바뀌어서 케이블로 송출된다.

전송 후 회신되는 패킷을 받는 것은 이와 반대의 순서대로 이루어진다.

<img width="1034" alt="스크린샷 2024-07-31 오후 4 56 42" src="https://github.com/user-attachments/assets/c13b260f-83e2-4a8d-a3b6-7eb3bfeb00ab">

#### 수신처 IP 주소를 기록한 IP 헤더 만들기
IP 헤더에는 수신처의 IP 주소, 송신처의 IP 주소, 프로토콜 버전 등의 정보가 담긴다.

송신처의 IP 주소 또한 헤더에 담아야 하기 때문에 여러개의 네트워크 하드웨어가 있을 경우 어떤 IP를 사용할지 결정이 필요하다.

이 때 라우팅 테이블을 이용하여 어떠한 LAN 어댑터를 사용할지 결정하고, IP 주소를 확정한다.

#### 이더넷용 MAC 헤더 만들기
MAC 헤더는 IP 헤더의 앞쪽에 붙게 되는데, 여기에는 송신처와 수신처 MAC 주소, 그리고 사용하는 프로토콜의 종류를 나타내는 이더 타입이 기록된다.

이 헤더를 만드는 과정에서 수신처의 MAC 주소를 알아내는 과정이 필요한데, 우선 라우팅 테이블을 통해 상대 라우터의 IP 주소는 알아낼 수 있다.
하지만 상대의 MAC 주소는 알아낼 수 없기 때문에 이를 조사하는 과정이 필요하다.
#### ARP로 수신처 라우터의 MAC 주소 조사하기
ARP는 Address Resolution Protocol의 약자로, 이더넷에서 연결되어 있는 기기 전원에게 브로드캐스트를 이용하여 특정 IP 주소를 가진 
기기를 찾는 방송을 내보내고 해당되는 기기가 자신의 MAC 주소를 알려주는 프로토콜이다.

또한 ARP 캐시를 이용하여 매번 방송하지 않아도 빠르게 MAC 주소를 알아낼 수도 있다.
#### 이더넷의 기본

<img width="612" alt="스크린샷 2024-07-31 오후 5 02 11" src="https://github.com/user-attachments/assets/1bd236a1-7927-45be-885c-22a632444687">

#### IP 패킷을 전기나 빛의 신호로 변환하여 송신한다
이제 MAC 헤더까지 붙이게 되면, LAN 어댑터가 패킷의 디지털 데이터를 전기나 빛의 신호로 변환하여 네트워크 케이블에 송출한다.

LAN 어댑터는 사용 전에 초기 설정과 이상 검사, MAC 회로에 MAC 주소를 설정하는 초기화 동작이 필요하다. 이 동작은 OS가 기동될 때 수행된다.

#### 패킷에 3개의 제어용 데이터를 추가한다

<img width="1100" alt="스크린샷 2024-07-31 오후 5 02 48" src="https://github.com/user-attachments/assets/822a0895-9817-4f6a-8fbf-5c8063bff07b">

#### 허브를 향해 패킷을 송신한다
이제 허브를 향해 패킷을 보내는데, 리피터 허브를 사용하는 경우 반이중 모드, 스위칭 허브를 사용하는 경우 전이중 모드의 두 가지 방법이 있다.

반이중 모드는 신호의 충돌이 있을 수 있다. 따라서 신호가 이미 흐르고 있는 경우 기다렸다가 송신을 해야 한다.
송신을 진행하면 패킷은 전기 신호로 변환되고, 이를 PHY, MAU라는 부분에 보낸다. 

반이중 모드에서 만약 서로의 신호가 뒤섞이는 경우 충돌이 발생하는데, 이 경우 충돌을 알리기 위해 재밍 신호라는 것을 이용하게 된다.
#### 돌아온 패킷을 받는다 & 받은 패킷을 IP에서 TCP로 넘긴다

<img width="978" alt="스크린샷 2024-07-31 오후 5 03 22" src="https://github.com/user-attachments/assets/f6a6cd1d-494d-4d26-8d55-671137cf0f9b">
